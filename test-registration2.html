<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Test Registration (RPC)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
    input { padding: 10px; margin: 5px; width: 320px; max-width: 100%; }
    button { padding: 10px 20px; margin: 5px; background: #007bff; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0056b3; }
    #result { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; white-space: pre-wrap; }
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .info { color: #17a2b8; }
    .warn { color: #ff8800; }
  </style>
</head>
<body>
  <h1>üîß Manager Registration Test (RPC bootstrap)</h1>

  <div class="test-section">
    <h2>Quick Registration</h2>
    <button onclick="testQuick()">Test Quick Registration</button>
  </div>

  <div class="test-section">
    <h2>Custom Registration</h2>
    <input id="companyName" placeholder="Company Name" value="Test Company" />
    <input id="email" placeholder="Email" value="test@example.com" />
    <input id="password" placeholder="Password" value="password123" />
    <button onclick="testCustom()">Test Custom Registration</button>
  </div>

  <div class="test-section">
    <button onclick="clearLocal()">Clear LocalStorage</button>
    <button onclick="signOut()">Sign Out</button>
  </div>

  <div id="result"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
  <script>
    const supabase = window.supabase.createClient(
      'https://hqmtigcjyqckqdzepcdu.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxbXRpZ2NqeXFja3FkemVwY2R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwODgwMjYsImV4cCI6MjA4NDY2NDAyNn0.Rs6yv54hZyXzqqWQM4m-Z4g3gKqacBeDfHiMfpOuFRw'
    );

    function show(message, type='info') {
      document.getElementById('result').innerHTML = `<div class="${type}">${message}</div>`;
      console.log(message);
    }

    async function signOut() {
      await supabase.auth.signOut();
      show('‚úÖ Signed out', 'success');
    }

    function clearLocal() {
      localStorage.clear();
      show('‚úÖ LocalStorage cleared', 'success');
    }

    async function ensureSession(email, password) {
      const { data } = await supabase.auth.getSession();
      if (data?.session?.access_token) return data.session;

      const { data: signInData, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) throw new Error('Sign-in failed: ' + error.message);
      return signInData.session;
    }

    async function testQuick() {
      const t = Date.now();
      await testRegistration(`test${t}@example.com`, 'password123', `Test Company ${t}`);
    }

    async function testCustom() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const companyName = document.getElementById('companyName').value.trim();
      if (!email || !password || !companyName) return show('Fill all fields', 'error');
      await testRegistration(email, password, companyName);
    }

    async function testRegistration(email, password, companyName) {
      try {
        show('Step 1: signUp...', 'info');
        const { data: authData, error: signUpError } = await supabase.auth.signUp({
          email,
          password,
          options: { data: { role: 'manager' } }
        });
        if (signUpError) throw new Error(signUpError.message);
        show(`‚úÖ User created: ${authData.user.id}`, 'success');

        show('Step 2: ensure session...', 'info');
        const session = await ensureSession(email, password);
        show('‚úÖ Session active. JWT present: ' + (session?.access_token ? 'YES' : 'NO'), 'success');

        show('Step 3: bootstrap company/profile/staff via RPC...', 'info');
        const { data: companyId, error: rpcError } = await supabase.rpc('bootstrap_manager_company', {
          company_name: companyName
        });
        if (rpcError) throw new Error('RPC failed: ' + rpcError.message);

        show(`üéâ DONE!\nCompany ID: ${companyId}\nEmail: ${email}\nNow open manager.html`, 'success');

        // emulate app local storage
        localStorage.setItem('cleaning_timesheet_role', 'manager');
        localStorage.setItem('cleaning_timesheet_company_id', companyId);

      } catch (e) {
        show('‚ùå ERROR: ' + e.message, 'error');
        console.error(e);
      }
    }
  </script>
</body>
</html>
