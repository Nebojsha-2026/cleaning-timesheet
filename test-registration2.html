<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Registration - No Redirect</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #result { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <h1>üîß Registration Test (No Auto-Redirect)</h1>
    
    <div class="test-section">
        <h2>Test 1: Quick Registration</h2>
        <button onclick="testQuickRegistration()">Test Quick Registration</button>
        <p>Creates a test account with random email</p>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Custom Registration</h2>
        <input type="text" id="companyName" placeholder="Company Name" value="Test Company">
        <input type="email" id="email" placeholder="Email" value="test@example.com">
        <input type="password" id="password" placeholder="Password" value="password123">
        <button onclick="testCustomRegistration()">Test Custom Registration</button>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Check Database</h2>
        <button onclick="checkDatabase()">Check Database Tables</button>
        <button onclick="clearLocalStorage()">Clear LocalStorage</button>
    </div>
    
    <div id="result"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script>
        // Initialize Supabase directly (bypassing auth.js)
        const supabase = window.supabase.createClient(
            'https://hqmtigcjyqckqdzepcdu.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxbXRpZ2NqeXFja3FkemVwY2R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwODgwMjYsImV4cCI6MjA4NDY2NDAyNn0.Rs6yv54hZyXzqqWQM4m-Z4g3gKqacBeDfHiMfpOuFRw'
        );
        
        async function testQuickRegistration() {
            const timestamp = Date.now();
            const email = `test${timestamp}@example.com`;
            const companyName = `Test Company ${timestamp}`;
            const password = 'password123';
            
            await testRegistration(email, password, companyName);
        }
        
        async function testCustomRegistration() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const companyName = document.getElementById('companyName').value;
            
            if (!email || !password || !companyName) {
                showResult('Please fill in all fields', 'error');
                return;
            }
            
            await testRegistration(email, password, companyName);
        }
        
        async function testRegistration(email, password, companyName) {
            showResult('Starting registration...', 'info');
            
            try {
                // Step 1: Sign up user
                showResult('Step 1: Creating user...', 'info');
                const { data: authData, error: signUpError } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: { data: { role: 'manager' } }
                });
                
                if (signUpError) throw new Error('Signup failed: ' + signUpError.message);
                if (!authData.user) throw new Error('No user created');
                
                showResult('‚úÖ User created: ' + authData.user.id, 'success');
                
                // Wait for profile creation
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Step 2: Create company
                showResult('Step 2: Creating company...', 'info');
                const { data: company, error: companyError } = await supabase
                    .from('companies')
                    .insert([{ 
                        name: companyName, 
                        custom_title: companyName + ' Timesheet',
                        primary_color: '#667eea',
                        secondary_color: '#764ba2'
                    }])
                    .select()
                    .single();
                    
                if (companyError) throw new Error('Company creation failed: ' + companyError.message);
                
                showResult('‚úÖ Company created: ' + company.id, 'success');
                
                // Step 3: Update profile
                showResult('Step 3: Updating profile...', 'info');
                const { error: profileError } = await supabase
                    .from('profiles')
                    .update({
                        company_id: company.id,
                        role: 'manager',
                        name: 'Manager',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', authData.user.id);
                    
                if (profileError) throw new Error('Profile update failed: ' + profileError.message);
                
                showResult('‚úÖ Profile updated with manager role', 'success');
                
                // Step 4: Create staff record
                showResult('Step 4: Creating staff record...', 'info');
                const { error: staffError } = await supabase
                    .from('staff')
                    .insert([{
                        user_id: authData.user.id,
                        company_id: company.id,
                        name: 'Manager',
                        email: email,
                        role: 'manager'
                    }]);
                    
                if (staffError) {
                    showResult('‚ö†Ô∏è Staff record warning: ' + staffError.message, 'info');
                } else {
                    showResult('‚úÖ Staff record created', 'success');
                }
                
                // Step 5: Sign in
                showResult('Step 5: Signing in...', 'info');
                const { error: signInError } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (signInError) {
                    showResult('‚ö†Ô∏è Auto login warning: ' + signInError.message, 'info');
                } else {
                    showResult('‚úÖ Auto login successful', 'success');
                }
                
                // Set localStorage manually
                localStorage.setItem('cleaning_timesheet_role', 'manager');
                localStorage.setItem('cleaning_timesheet_company_id', company.id);
                localStorage.setItem('cleaning_timesheet_token', (await supabase.auth.getSession()).data.session?.access_token || '');
                localStorage.setItem('cleaning_timesheet_user', JSON.stringify(authData.user));
                
                showResult(`
                    üéâ REGISTRATION COMPLETE!
                    Email: ${email}
                    Company: ${companyName}
                    User ID: ${authData.user.id}
                    Company ID: ${company.id}
                    Role in localStorage: ${localStorage.getItem('cleaning_timesheet_role')}
                    
                    <button onclick="window.location.href='manager.html'">Go to Manager Dashboard</button>
                    <button onclick="window.location.href='employee.html'">Go to Employee Dashboard</button>
                `, 'success');
                
            } catch (error) {
                showResult('‚ùå ERROR: ' + error.message, 'error');
                console.error('Test registration error:', error);
            }
        }
        
        async function checkDatabase() {
            showResult('Checking database tables...', 'info');
            
            try {
                // Check companies
                const { data: companies, error: companiesError } = await supabase
                    .from('companies')
                    .select('id, name, created_at')
                    .order('created_at', { ascending: false })
                    .limit(5);
                    
                if (companiesError) throw companiesError;
                
                // Check profiles
                const { data: profiles, error: profilesError } = await supabase
                    .from('profiles')
                    .select('id, role, company_id, created_at')
                    .order('created_at', { ascending: false })
                    .limit(5);
                    
                if (profilesError) throw profilesError;
                
                // Check staff
                const { data: staff, error: staffError } = await supabase
                    .from('staff')
                    .select('id, name, email, role, company_id')
                    .order('created_at', { ascending: false })
                    .limit(5);
                    
                if (staffError) throw staffError;
                
                let resultHtml = '<h3>Database Status:</h3>';
                
                resultHtml += '<h4>Recent Companies:</h4>';
                if (companies.length > 0) {
                    resultHtml += '<ul>';
                    companies.forEach(company => {
                        resultHtml += `<li>${company.name} (ID: ${company.id}) - ${new Date(company.created_at).toLocaleString()}</li>`;
                    });
                    resultHtml += '</ul>';
                } else {
                    resultHtml += '<p>No companies found</p>';
                }
                
                resultHtml += '<h4>Recent Profiles:</h4>';
                if (profiles.length > 0) {
                    resultHtml += '<ul>';
                    profiles.forEach(profile => {
                        resultHtml += `<li>${profile.role} (Company: ${profile.company_id}) - ${new Date(profile.created_at).toLocaleString()}</li>`;
                    });
                    resultHtml += '</ul>';
                } else {
                    resultHtml += '<p>No profiles found</p>';
                }
                
                resultHtml += '<h4>Recent Staff:</h4>';
                if (staff.length > 0) {
                    resultHtml += '<ul>';
                    staff.forEach(s => {
                        resultHtml += `<li>${s.name} (${s.email}) - ${s.role}</li>`;
                    });
                    resultHtml += '</ul>';
                } else {
                    resultHtml += '<p>No staff found</p>';
                }
                
                showResult(resultHtml, 'success');
                
            } catch (error) {
                showResult('‚ùå Database check error: ' + error.message, 'error');
            }
        }
        
        function clearLocalStorage() {
            localStorage.clear();
            showResult('‚úÖ LocalStorage cleared', 'success');
        }
        
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="${type}">${message}</div>`;
            console.log(message);
        }
    </script>
</body>
</html>
